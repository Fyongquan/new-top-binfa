# ç§’æ€ç³»ç»Ÿé—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†åœ¨åŸºäº Redis+Lua+RabbitMQ çš„é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿå®ç°è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ã€åˆ†æè¿‡ç¨‹ã€è§£å†³æ–¹æ¡ˆåŠä¿®å¤æ•ˆæœéªŒè¯ã€‚

**é¡¹ç›®æŠ€æœ¯æ ˆï¼š**

- **åç«¯æ¡†æ¶**: Spring Boot 3.4 + Java 17
- **ç¼“å­˜ç³»ç»Ÿ**: Redis 7.x (Lua è„šæœ¬åŸå­æ“ä½œ)
- **æ¶ˆæ¯é˜Ÿåˆ—**: RabbitMQ 3.x (å¼‚æ­¥è®¢å•å¤„ç†)
- **æ•°æ®åº“**: MySQL 8.0 + MyBatis
- **è¿æ¥æ± **: HikariCP
- **åºåˆ—åŒ–**: StringRedisSerializer (ä¿®å¤å)

---

## ğŸ› é—®é¢˜æ¸…å•

### 1. ç¼–è¯‘é˜¶æ®µé—®é¢˜

- **é—®é¢˜ 1.1**: Maven ç¼–è¯‘å¤±è´¥ - Java ç‰ˆæœ¬ä¸åŒ¹é…
- **é—®é¢˜ 1.2**: javax vs jakarta åŒ…å¯¼å…¥å†²çª
- **é—®é¢˜ 1.3**: HikariCP é…ç½®å‚æ•°é”™è¯¯
- **é—®é¢˜ 1.4**: MyBatis XML æ ¼å¼è§£æé”™è¯¯

### 2. è¿è¡Œæ—¶é—®é¢˜

- **é—®é¢˜ 2.1**: åº”ç”¨å¯åŠ¨å¤±è´¥ - MySQL è¿æ¥å¼‚å¸¸
- **é—®é¢˜ 2.2**: ç§’æ€åŠŸèƒ½å¤±è´¥ - Lua è„šæœ¬è¯»å–æ•°æ®ä¸º null
- **é—®é¢˜ 2.3**: Redis åºåˆ—åŒ–é—®é¢˜ - JSON åŒé‡ç¼–ç 
- **é—®é¢˜ 2.4**: RabbitMQ å¹¶å‘å†²çª - ConfirmCallback é‡å¤è®¾ç½®

---

## ğŸ” è¯¦ç»†é—®é¢˜åˆ†æä¸ä¿®å¤

### é—®é¢˜ 1: ç¼–è¯‘ç¯å¢ƒé…ç½®

#### 1.1 Java ç‰ˆæœ¬é…ç½®

**ç°è±¡**:

```
æ— æ•ˆçš„ç›®æ ‡å‘è¡Œç‰ˆ: 17
```

**åˆ†æ**: Maven ç¼–è¯‘æ’ä»¶é…ç½®ä¸å®é™… Java ç‰ˆæœ¬ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:

- ç¡®è®¤ JDK 17 æ­£ç¡®å®‰è£…å’Œç¯å¢ƒé…ç½®
- éªŒè¯ Maven é…ç½®ä½¿ç”¨æ­£ç¡®çš„ Java ç‰ˆæœ¬

#### 1.2 Jakarta EE è¿ç§»é—®é¢˜

**ç°è±¡**:

```java
ç¨‹åºåŒ…javax.annotationä¸å­˜åœ¨
æ‰¾ä¸åˆ°ç¬¦å· ç±» Resource, Valid, NotNull, Positive
```

**åˆ†æ**: Spring Boot 3.x è¿ç§»åˆ° Jakarta EEï¼Œ`javax.*` åŒ…åå˜æ›´ä¸º `jakarta.*`

**è§£å†³æ–¹æ¡ˆ**:

```xml
<!-- æ·»åŠ Jakartaä¾èµ– -->
<dependency>
    <groupId>jakarta.annotation</groupId>
    <artifactId>jakarta.annotation-api</artifactId>
</dependency>
<dependency>
    <groupId>jakarta.validation</groupId>
    <artifactId>jakarta.validation-api</artifactId>
</dependency>
```

**ä¿®å¤æ–‡ä»¶**:

- `SeckillController.java`, `SeckillService.java`
- `RedisService.java`, `OrderProducer.java`, `OrderConsumer.java`
- `GlobalExceptionHandler.java`, `MyBatisConfig.java`
- `SeckillRequest.java`

#### 1.3 HikariCP é…ç½®ä¼˜åŒ–

**ç°è±¡**:

```java
æ‰¾ä¸åˆ°ç¬¦å· æ–¹æ³• setCachePrepStmts(boolean)
```

**åˆ†æ**: MySQL æ€§èƒ½å‚æ•°åº”ä½œä¸º JDBC URL å‚æ•°ä¼ é€’ï¼Œè€Œéç›´æ¥è®¾ç½®åœ¨ HikariConfig å¯¹è±¡ä¸Š

**è§£å†³æ–¹æ¡ˆ**:

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/seckill_test?useUnicode=true&characterEncoding=utf8&cachePrepStmts=true&prepStmtCacheSize=250&prepStmtCacheSqlLimit=2048&useServerPrepStmts=true
```

### é—®é¢˜ 2: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¿®å¤

#### 2.1 Redis åºåˆ—åŒ–é—®é¢˜ ğŸš¨**æ ¸å¿ƒé—®é¢˜**

**ç°è±¡**:

- Java å­˜å‚¨: `"100"` â†’ Redis å®é™…å­˜å‚¨: `"\"100\""`
- Lua è„šæœ¬è¯»å–: `GET seckill:stock:1` â†’ è¿”å› `nil`

**æ ¹æœ¬åŸå› åˆ†æ**:

```java
// é—®é¢˜é…ç½® âŒ
template.setValueSerializer(new GenericJackson2JsonRedisSerializer());

// Javaå­—ç¬¦ä¸²"100"è¢«JSONåºåˆ—åŒ–ä¸º"\"100\""ï¼Œå¯¼è‡´Luaè„šæœ¬æ— æ³•è¯»å–
```

**ä¿®å¤æ–¹æ¡ˆ**:

```java
// æ­£ç¡®é…ç½® âœ…
template.setValueSerializer(new StringRedisSerializer());
template.setHashValueSerializer(new StringRedisSerializer());
```

**ä¿®å¤æ–‡ä»¶**: `src/main/java/com/seckill/config/RedisConfig.java`

**å½±å“èŒƒå›´**: æ¶‰åŠæ‰€æœ‰ Redis å­˜å‚¨æ“ä½œçš„ç±»å‹è½¬æ¢

```java
// RedisService.java ä¸­æ‰€æœ‰å­˜å‚¨æ–¹æ³•éƒ½éœ€è¦ç¡®ä¿å­—ç¬¦ä¸²åŒ–
public void setOrderStatus(Long orderId, Integer status, long expireSeconds) {
    redisTemplate.opsForValue().set(orderStatusKey, status.toString(), expireSeconds, TimeUnit.SECONDS);
}
```

#### 2.2 Lua è„šæœ¬ KEYS å‚æ•°ä¼ é€’

**ç°è±¡**:

```
ğŸ“¦ åº“å­˜åŸå§‹æ•°æ®: 100 (ç±»å‹: String)  âœ…
ğŸ“¦ Luaè„šæœ¬è¯»å–çš„åŸå§‹å€¼: null      âŒ
```

**åˆ†æ**: `redisTemplate.execute(script, keys, args...)` çš„ KEYS å‚æ•°æœªæ­£ç¡®ä¼ é€’

**é”™è¯¯ç”¨æ³•**:

```java
âŒ Long result = redisTemplate.execute(
    seckillScript,
    Collections.emptyList(),  // KEYSä¸ºç©º
    voucherId.toString(),     // ARGV[1]
    userId.toString()         // ARGV[2]
);
```

**æ­£ç¡®ç”¨æ³•**:

```java
âœ… java.util.List<String> keys = java.util.Arrays.asList(
    "seckill:stock:" + voucherId,  // KEYS[1]
    "seckill:order:" + voucherId   // KEYS[2]
);
Long result = redisTemplate.execute(seckillScript, keys, voucherId.toString(), userId.toString());
```

**ä¿®å¤æ–‡ä»¶**:

- `src/main/java/com/seckill/service/RedisService.java`
- `src/main/resources/lua/seckill.lua`
- `src/main/resources/lua/recover_stock.lua`

#### 2.3 RabbitMQ å¹¶å‘é—®é¢˜

**ç°è±¡**:

```java
java.lang.IllegalStateException: Only one ConfirmCallback is supported by each RabbitTemplate
```

**åˆ†æ**: å¹¶å‘ç¯å¢ƒä¸‹æ¯ä¸ªè¯·æ±‚éƒ½è¯•å›¾è®¾ç½® ConfirmCallbackï¼Œä½† RabbitTemplate åªå…è®¸è®¾ç½®ä¸€æ¬¡

**ä¿®å¤æ–¹æ¡ˆ**:

```java
// é”™è¯¯æ–¹å¼ âŒ - æ¯æ¬¡å‘é€æ¶ˆæ¯éƒ½è®¾ç½®
public void sendOrderMessage(OrderMessage orderMessage) {
    rabbitTemplate.setConfirmCallback(...); // å¹¶å‘å†²çª
}

// æ­£ç¡®æ–¹å¼ âœ… - åº”ç”¨å¯åŠ¨æ—¶è®¾ç½®ä¸€æ¬¡
@PostConstruct
public void initRabbitTemplate() {
    rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -> {
        String messageId = correlationData != null ? correlationData.getId() : "unknown";
        if (ack) {
            log.info("è®¢å•æ¶ˆæ¯å‘é€æˆåŠŸ - æ¶ˆæ¯ID: {}", messageId);
        } else {
            log.error("è®¢å•æ¶ˆæ¯å‘é€å¤±è´¥ - æ¶ˆæ¯ID: {}, åŸå› : {}", messageId, cause);
        }
    });
}
```

**ä¿®å¤æ–‡ä»¶**: `src/main/java/com/seckill/mq/producer/OrderProducer.java`

---

## ğŸ› ï¸ ä¿®å¤æ–‡ä»¶æ±‡æ€»

### é…ç½®ç±»ä¿®å¤

| æ–‡ä»¶                    | ä¿®å¤å†…å®¹                   | å½±å“           |
| ----------------------- | -------------------------- | -------------- |
| `pom.xml`               | æ·»åŠ  Jakarta ä¾èµ–          | è§£å†³ç¼–è¯‘é—®é¢˜   |
| `RedisConfig.java`      | StringRedisSerializer é…ç½® | **æ ¸å¿ƒä¿®å¤**   |
| `DataSourceConfig.java` | HikariCP å‚æ•°ä¼˜åŒ–          | æ€§èƒ½æå‡       |
| `application.yml`       | JDBC URL å‚æ•°è°ƒæ•´          | æ•°æ®åº“è¿æ¥ä¼˜åŒ– |

### ä¸šåŠ¡é€»è¾‘ä¿®å¤

| æ–‡ä»¶                 | ä¿®å¤å†…å®¹                 | å½±å“           |
| -------------------- | ------------------------ | -------------- |
| `RedisService.java`  | KEYS å‚æ•°ä¼ é€’ + ç±»å‹è½¬æ¢ | **æ ¸å¿ƒä¿®å¤**   |
| `OrderProducer.java` | ConfirmCallback å¹¶å‘é—®é¢˜ | æ¶ˆæ¯é˜Ÿåˆ—ç¨³å®šæ€§ |
| `seckill.lua`        | å‚æ•°æ¥æ”¶æ–¹å¼è°ƒæ•´         | åŸå­æ“ä½œæ­£ç¡®æ€§ |
| `recover_stock.lua`  | KEYS å‚æ•°è°ƒæ•´            | å›æ»šé€»è¾‘ä¿®å¤   |

### å¯¼å…¥åŒ…ä¿®å¤

**æ‰¹é‡ä¿®å¤ javax â†’ jakarta**:

- `SeckillController.java`, `SeckillService.java`, `OrderService.java`
- `RedisService.java`, `OrderProducer.java`, `OrderConsumer.java`
- `GlobalExceptionHandler.java`, `MyBatisConfig.java`
- `SeckillRequest.java`

---

## ğŸ§ª éªŒè¯ç»“æœ

### ä¿®å¤å‰ âŒ

```
ç§’æ€è„šæœ¬æ‰§è¡Œç»“æœ: 1 (åº“å­˜ä¸è¶³)
é”™è¯¯: Luaè„šæœ¬è¯»å–æ•°æ®ä¸ºnull
åŸå› : Redisåºåˆ—åŒ–+KEYSå‚æ•°é—®é¢˜
```

### ä¿®å¤å âœ…

```
ç§’æ€è„šæœ¬æ‰§è¡Œç»“æœ: 0 (æˆåŠŸ)
åº“å­˜æ­£ç¡®æ‰£å‡: 100 â†’ 99 â†’ 98 â†’ ...
å¹¶å‘æ§åˆ¶æ­£å¸¸: 5ä¸ªåº“å­˜ï¼Œæ­£ç¡®è¯†åˆ«åç»­åº“å­˜ä¸è¶³
æ¶ˆæ¯é˜Ÿåˆ—æ­£å¸¸: RabbitMQæ¶ˆæ¯å‘é€æˆåŠŸ
```

### å¹¶å‘æµ‹è¯•éªŒè¯

**æµ‹è¯•åœºæ™¯**: 10 ä¸ªç”¨æˆ·æŠ¢è´­ 5 ä¸ªåº“å­˜

```
åˆå§‹åŒ–åº“å­˜: 5
âœ… æˆåŠŸç”¨æˆ·: 5ä¸ª (ç”¨æˆ·9004, 9005, 9008, 9006, 9003)
âŒ å¤±è´¥ç”¨æˆ·: 5ä¸ª (åº“å­˜ä¸è¶³ï¼Œç¬¦åˆé¢„æœŸ)
æœ€ç»ˆåº“å­˜: 0
æ•°æ®ä¸€è‡´æ€§: âœ… å®Œç¾
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–äº®ç‚¹

### 1. Redis ä¼˜åŒ–

- âœ… **Lua è„šæœ¬åŸå­æ“ä½œ**: é¿å…åˆ†å¸ƒå¼é”çš„æ€§èƒ½æŸè€—
- âœ… **å­—ç¬¦ä¸²åºåˆ—åŒ–**: å‡å°‘ JSON åºåˆ—åŒ–å¼€é”€
- âœ… **é”®å€¼ä¼˜åŒ–**: é«˜æ•ˆçš„é”®å‘½åè§„åˆ™

### 2. æ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–

- âœ… **å¼‚æ­¥å¤„ç†**: ç§’æ€æˆåŠŸç«‹å³è¿”å›ï¼Œè®¢å•å¤„ç†å¼‚æ­¥åŒ–
- âœ… **æ¶ˆæ¯ç¡®è®¤**: Producer ACK + Consumer æ‰‹åŠ¨ç¡®è®¤
- âœ… **å®¹é”™å¤„ç†**: æ­»ä¿¡é˜Ÿåˆ— + é‡è¯•æœºåˆ¶

### 3. æ•°æ®åº“ä¼˜åŒ–

- âœ… **è¿æ¥æ± **: HikariCP æ€§èƒ½å‚æ•°è°ƒä¼˜
- âœ… **æ‰¹é‡æ“ä½œ**: MyBatis æ‰¹é‡æ’å…¥ä¼˜åŒ–
- âœ… **è¯»å†™åˆ†ç¦»**: åº“å­˜è¯» Redisï¼Œè®¢å•å†™ MySQL

---

## ğŸ”§ è°ƒè¯•å·¥å…·å¢å¼º

### å¼€å‘è°ƒè¯•æ–¹æ³•

```java
// Redisæ•°æ®è°ƒè¯•
public void debugRedisData(Long voucherId) {
    String stockKey = "seckill:stock:" + voucherId;
    Object stockData = redisTemplate.opsForValue().get(stockKey);
    log.info("ğŸ“¦ åº“å­˜åŸå§‹æ•°æ®: {} (ç±»å‹: {})", stockData, stockData.getClass().getSimpleName());
}
```

### Lua è„šæœ¬è°ƒè¯•ä¿¡æ¯

```lua
-- è¯¦ç»†è°ƒè¯•ä¿¡æ¯è®°å½•
local debugKey = 'seckill:debug:' .. voucherId
redis.call('HSET', debugKey, 'raw_stock', tostring(stockValue or 'nil'))
redis.call('HSET', debugKey, 'parsed_stock', tostring(stock or 'nil'))
redis.call('HSET', debugKey, 'stockKey', stockKey)
```

---

## âœ… ä¿®å¤æ€»ç»“

### å…³é”®æŠ€æœ¯é—®é¢˜è§£å†³

1. **ğŸ¯ Redis åºåˆ—åŒ–é—®é¢˜**: ä» JSON åŒé‡ç¼–ç æ”¹ä¸º String ç›´æ¥åºåˆ—åŒ–
2. **ğŸ¯ Lua è„šæœ¬å‚æ•°ä¼ é€’**: æ­£ç¡®ä½¿ç”¨ KEYS æ•°ç»„è€Œé ARGV æ‹¼æ¥
3. **ğŸ¯ RabbitMQ å¹¶å‘å†²çª**: ConfirmCallback å•ä¾‹æ¨¡å¼è®¾ç½®
4. **ğŸ¯ Jakarta EE è¿ç§»**: Spring Boot 3.x åŒ…åæ›´æ–°

### ç³»ç»Ÿç¨³å®šæ€§æå‡

- âœ… **åŸå­æ€§ä¿è¯**: Redis Lua è„šæœ¬ç¡®ä¿åº“å­˜æ“ä½œåŸå­æ€§
- âœ… **æ•°æ®ä¸€è‡´æ€§**: ä¸¥æ ¼çš„åº“å­˜æ‰£å‡å’Œå›æ»šæœºåˆ¶
- âœ… **é«˜å¹¶å‘å¤„ç†**: æ”¯æŒå¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­
- âœ… **æ¶ˆæ¯å¯é æ€§**: RabbitMQ ç¡®ä¿è®¢å•æ¶ˆæ¯ä¸ä¸¢å¤±

### å¼€å‘æ•ˆç‡æå‡

- âœ… **é—®é¢˜å®šä½**: å¢åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å’Œæ–¹æ³•
- âœ… **æµ‹è¯•è¦†ç›–**: å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•
- âœ… **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä¿®å¤è®°å½•å’Œä½¿ç”¨æŒ‡å—
- âœ… **ä»£ç æ¸…ç†**: åˆ é™¤ä¸´æ—¶è°ƒè¯•ä»£ç ï¼Œä¿æŒä»£ç æ•´æ´

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ç›‘æ§

- æ·»åŠ  Redisã€RabbitMQã€MySQL çš„ç›‘æ§æŒ‡æ ‡
- é›†æˆ APM å·¥å…·ç›‘æ§æ¥å£å“åº”æ—¶é—´
- è®¾ç½®å…³é”®ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦

### 2. æ‰©å±•æ€§ä¼˜åŒ–

- Redis é›†ç¾¤éƒ¨ç½²æ”¯æŒæ›´å¤§å¹¶å‘é‡
- RabbitMQ é›†ç¾¤ä¿è¯æ¶ˆæ¯é˜Ÿåˆ—é«˜å¯ç”¨
- æ•°æ®åº“è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨

### 3. ä¸šåŠ¡åŠŸèƒ½å¢å¼º

- æ·»åŠ åº“å­˜é¢„çƒ­æœºåˆ¶
- å®ç°åŠ¨æ€é™æµå’Œç†”æ–­
- æ”¯æŒå¤šç§ä¼˜æƒ åˆ¸ç±»å‹å’Œé™è´­ç­–ç•¥

---

## ğŸ“ æŠ€æœ¯æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¿®å¤è¿‡ç¨‹ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿä¸­çš„å…³é”®æŠ€æœ¯é—®é¢˜ï¼š

1. **æ¶æ„è®¾è®¡**: Redis+Lua+RabbitMQ çš„ä¸‰å±‚æ¶æ„è®¾è®¡åˆç†æœ‰æ•ˆ
2. **é—®é¢˜å®šä½**: é€šè¿‡ç³»ç»Ÿæ€§çš„æ—¥å¿—åˆ†æå’Œè°ƒè¯•ï¼Œå‡†ç¡®å®šä½äº†æ ¹æœ¬åŸå› 
3. **è§£å†³æ–¹æ¡ˆ**: é‡‡ç”¨äº†æŠ€æœ¯ä¸Šæœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆï¼Œè€Œéä¸´æ—¶æ€§è¡¥ä¸
4. **éªŒè¯æµ‹è¯•**: å®Œæ•´çš„æµ‹è¯•éªŒè¯ç¡®ä¿äº†ä¿®å¤æ•ˆæœå’Œç³»ç»Ÿç¨³å®šæ€§

**æœ€ç»ˆæˆæœ**: æ„å»ºäº†ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€æ•°æ®ä¸€è‡´æ€§å¼ºçš„åˆ†å¸ƒå¼ç§’æ€ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ”¯æŒé«˜å¹¶å‘åœºæ™¯ä¸‹çš„ä¸šåŠ¡éœ€æ±‚ã€‚

---

_ä¿®å¤å®Œæˆæ—¶é—´: 2025-09-01_  
_æŠ€æœ¯æ ˆ: Spring Boot 3.4 + Redis + RabbitMQ + MySQL_  
_ä¿®å¤é—®é¢˜æ•°: 10 ä¸ªå…³é”®é—®é¢˜_  
_ä»£ç è´¨é‡: ç”Ÿäº§å°±ç»ªçº§åˆ«_
