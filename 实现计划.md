# 高并发秒杀功能实现计划

## 目标

实现一个简化的秒杀系统，用于测试高并发场景下 Redis+Lua 脚本+MQ 的处理能力

## 核心功能范围

### 1. Redis 层面处理（核心）

- 实现库存检查和扣减的 Lua 脚本
- 实现用户限购检查的 Lua 脚本
- 实现库存回滚的 Lua 脚本
- Redis 数据结构设计：
  - `seckill:stock:{voucherId}` - 库存数量
  - `seckill:order:{voucherId}` - 用户购买记录 Hash

### 2. Web API 接口

- **POST /seckill** - 秒杀接口
  - 输入：userId, voucherId, limit
  - 返回：成功/失败状态
- **GET /seckill/status/{orderId}** - 查询订单状态
- **POST /seckill/init** - 初始化秒杀数据

### 3. 消息队列处理

- 使用 RabbitMQ 处理订单异步落库
- 实现生产者确认机制
- 实现消费者手动 ACK
- 失败重试和死信队列处理

### 4. 数据库设计（简化）

```sql
-- 优惠券表
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    stock INT,
    total_stock INT,
    start_time DATETIME,
    end_time DATETIME
);

-- 订单表
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,
    voucher_id BIGINT,
    status INT DEFAULT 0, -- 0:处理中 1:成功 2:失败
    create_time DATETIME,
    UNIQUE KEY uk_user_voucher (user_id, voucher_id)
);
```

### 5. 技术栈选择

- **后端**: JAVA17(spring boot3.4)
- **缓存**: Redis
- **消息队列**: RabbitMQ
- **数据库**: MySQL
- **数据库持久层**: MyBatis
- **测试工具**: 简单的并发测试脚本

## 实现优先级

### Phase 1: 核心 Redis+Lua 逻辑

1. Redis 连接和基础配置
2. 三个 Lua 脚本的实现和测试
3. 基础的秒杀接口

### Phase 2: MQ 异步处理

1. RabbitMQ 连接和队列配置
2. 消息生产者和消费者
3. 订单异步处理逻辑

### Phase 3: 完整链路测试

1. 数据库连接和基础表
2. 完整的秒杀流程测试
3. 并发测试脚本

## 测试场景

- 1000 个并发用户同时秒杀 100 个库存
- 验证数据一致性（Redis vs 数据库）
- 验证消息不丢失
- 验证限购逻辑正确性

## 文件结构

```
seckill-test/
├── pom.xml                           # Maven依赖配置
├── docker-compose.yml               # Redis、RabbitMQ、MySQL容器
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── seckill/
│   │   │           ├── SeckillApplication.java          # 启动类
│   │   │           ├── config/                          # 配置类
│   │   │           │   ├── RedisConfig.java            # Redis配置
│   │   │           │   ├── RabbitMQConfig.java         # RabbitMQ配置
│   │   │           │   ├── MyBatisConfig.java          # MyBatis配置
│   │   │           │   └── DataSourceConfig.java       # 数据源配置
│   │   │           ├── controller/                     # 控制器
│   │   │           │   └── SeckillController.java      # 秒杀接口
│   │   │           ├── service/                        # 服务层
│   │   │           │   ├── SeckillService.java         # 秒杀核心业务
│   │   │           │   ├── RedisService.java           # Redis操作服务
│   │   │           │   └── OrderService.java           # 订单处理服务
│   │   │           ├── mq/                             # 消息队列
│   │   │           │   ├── producer/
│   │   │           │   │   └── OrderProducer.java      # 订单消息生产者
│   │   │           │   └── consumer/
│   │   │           │       └── OrderConsumer.java      # 订单消息消费者
│   │   │           ├── entity/                         # 数据库实体类
│   │   │           │   ├── Coupon.java                 # 优惠券实体
│   │   │           │   └── Order.java                  # 订单实体
│   │   │           ├── dto/                            # 数据传输对象
│   │   │           │   ├── SeckillRequest.java         # 秒杀请求DTO
│   │   │           │   ├── SeckillResponse.java        # 秒杀响应DTO
│   │   │           │   └── OrderMessage.java           # 订单消息DTO
│   │   │           ├── mapper/                         # MyBatis Mapper接口
│   │   │           │   ├── CouponMapper.java           # 优惠券Mapper接口
│   │   │           │   └── OrderMapper.java            # 订单Mapper接口
│   │   │           └── exception/                      # 异常处理
│   │   │               ├── SeckillException.java       # 秒杀异常
│   │   │               └── GlobalExceptionHandler.java # 全局异常处理
│   │   └── resources/
│   │       ├── application.yml                         # 主配置文件
│   │       ├── application-dev.yml                     # 开发环境配置
│   │       ├── mybatis-config.xml                      # MyBatis全局配置
│   │       ├── lua/                                    # Redis Lua脚本
│   │       │   ├── seckill.lua                        # 秒杀脚本
│   │       │   └── recover_stock.lua                  # 库存回滚脚本
│   │       ├── mapper/                                 # MyBatis XML映射文件
│   │       │   ├── CouponMapper.xml                   # 优惠券SQL映射
│   │       │   └── OrderMapper.xml                    # 订单SQL映射
│   │       └── db/                                     # 数据库相关
│   │           ├── schema.sql                         # 数据库表结构
│   │           └── data.sql                           # 初始化数据
│   └── test/
│       └── java/
│           └── com/
│               └── seckill/
│                   ├── SeckillApplicationTests.java    # 基础测试
│                   ├── service/
│                   │   └── SeckillServiceTest.java     # 秒杀服务测试
│                   └── performance/
│                       └── ConcurrentTest.java         # 并发性能测试
└── scripts/
    ├── docker-setup.sh                                # Docker环境启动脚本
    ├── concurrent-test.py                              # Python并发测试脚本
    └── performance-monitor.py                          # 性能监控脚本
```

## 不实现的功能（简化）

- 用户认证和授权
- 复杂的前端页面
- 监控和告警
- 集群部署
- 详细的日志系统
- 完整的错误处理和边界情况

这样的实现可以有效验证高并发处理的核心逻辑，同时保持代码简洁可测试。
